<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BEAST Composer</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <script src="https://unpkg.com/react/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@material-ui/core/umd/material-ui.production.min.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script>
      const { AppBar, Drawer, List, ListItem, ListItemIcon, ListItemText, makeStyles, Toolbar, Typography, IconButton, Button } = MaterialUI;
      const { render } = ReactDOM;
      const { useState, useEffect, createElement: e } = React;
      const drawerWidth = 240;

      const useStyles = makeStyles((theme) => ({
        root: { display: 'flex' },
        appBar: { zIndex: 1 },
        drawer: { width: drawerWidth, flexShrink: 0 },
        drawerPaper: { width: drawerWidth },
        content: { flexGrow: 1, padding: 20, marginTop: 50 },
        connectionStatus: {
          flexGrow: 1,
          textAlign: "center",
          position: "absolute",
          top: 10,
          right: 10,
          width: 150,
          height: 30,
          paddingTop: 10,
          border: "1px solid black",
        },
        connected: { backgroundColor: "green" },
        disconnected: { backgroundColor: "red" },
      }));

      function App() {
        const classes = useStyles();
        const [content, setContent] = useState("Welcome Home!");
        const [title, setTitle] = useState("Home");
        const [status, setStatus] = useState([]);
        const [error, setError] = useState(null);
        const [connected, setConnected] = useState(false);

        useEffect(() => {
          const fetchData = async () => {
            try {
              const response = await fetch('/api/v1/status');
              if (!response.ok) {
                throw new Error('Network response was not ok');
                setConnected(false);
              }
              setConnected(true);
              try {
                const jsonData = await response.json();
                // Process the returned data
                setStatus(jsonData);
                setError(null); // Reset error state if successful
              } catch (error) {
                console.log("Json error");
                setError(error.message); // Set error state if unsuccessful
              }
            } catch (error) {
              setConnected(false);
              setError(error.message); // Set error state if unsuccessful
            }
          };
          fetchData();
          const interval = setInterval(() => {
            fetchData();
          }, 1000); // Fetch data every 5 seconds
          return () => clearInterval(interval);
        }, []);

        function PipelineList() {
          const [pipelines, setPipelines] = useState([]);

          useEffect(() => {
            const fetchData = async () => {
              try {
                const response = await fetch('/api/v1/pipelines');
                if (!response.ok) {
                  throw new Error('Network response was not ok');
                }
                try {
                  const jsonData = await response.json();
                  // Process the returned data
                  setPipelines(jsonData);
                } catch (error) {
                  setPipelines([]);
                  console.log("Json error");
                  setError(error.message); // Set error state if unsuccessful
                }
              } catch (error) {
                setPipelines([]);
                setError(error.message); // Set error state if unsuccessful
              }
            };
            fetchData();
            const interval = setInterval(fetchData, 1000);
            return () => clearInterval(interval);
          }, []);

          function showPipelineDetails(id) {
            alert(`Show details for pipeline ID: ${id}`);
          }

          async function handleButtonClick(id, action) {
            const response = await fetch(`/api/v1/pipelines/${id}/${action}`, {
              method: "GET",
            });
            // Handle response if necessary
          }

          return e(
            React.Fragment,
            null,
            e(
              Typography,
              { variant: "body1", style: { marginBottom: 20 } },
              "Below is a list of available pipelines. Click on a pipeline to view its details, or use the Play/Stop buttons to control its execution."
            ),
            e(
            List,
            null,
            pipelines.map((pipeline) =>
              e(
                ListItem,
                {
                  key: pipeline.id,
                  button: true,
                  onClick: () => showPipelineDetails(pipeline.id),
                },
                e(ListItemIcon, null, e("i", { className: "material-icons" }, "lan")),
                e(ListItemText, { primary: pipeline.name }),
                e(
                  Button,
                  {
                    variant: "contained",
                    style: {
                      backgroundColor: pipeline.state === "running" ? "red" : "green",
                      color: "white",
                    },
                    color: pipeline.state === "running" ? "secondary" : "primary",
                    onClick: (event) => {
                      event.stopPropagation();
                      handleButtonClick(pipeline.id, pipeline.state === "running" ? "stop" : "start");
                    },
                  },
                  pipeline.state === "running" ? e("i", { className: "material-icons" }, "stop") : e("i", { className: "material-icons" }, "play_arrow")
                )
              )
            ))
          );
        }

        const handlePipelinesClick = () => {
          setTitle('Pipelines');
          setContent(e(PipelineList));
        };


        const handleProgramCollectionClick = () => {
          setTitle('Program Collection');
          setContent('You have no program collection');
        };

        return (
          e("div", { className: classes.root },
            e(AppBar, { position: "fixed", className: classes.appBar },
              e(Toolbar, { style: { marginLeft: `${drawerWidth + 10}px` } },
                e(Typography, { variant: "h6" }, title),
                e(Typography, { variant: "h8",
                                className: classes.connectionStatus + " " +
                                           (connected ? classes.connected : classes.disconnected)},
                                connected ? ('Connected (v' + status["version"] + ')') : 'Disconnected')
              )
            ),
            e(Drawer, {
                className: classes.drawer,
                variant: "permanent",
                classes: {
                  paper: classes.drawerPaper,
                }
              },
              e(List, null,
                e(ListItem, { button: true, onClick: handlePipelinesClick },
                  e(ListItemIcon, null,
                    e("i", { className: "material-icons" }, "lan" )
                  ),
                  e(ListItemText, { primary: "Pipelines" })
                ),
                e(ListItem, { button: true, onClick: handleProgramCollectionClick },
                  e(ListItemIcon, null,
                    e("i", { className: "material-icons" }, "hive")
                  ),
                  e(ListItemText, { primary: "Program Collection" })
                )
              )
            ),
            e("main", { className: classes.content },
              e("p", null, content)
            )
          )
        );
      }

      render(e(App), document.getElementById("root"));
    </script>
  </body>
</html>
